<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#05080d">
<title>Afferent</title>
<link rel="manifest" href="/manifest.json">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    /* Black/Blue/White Material 3 Theme */
    --md-bg: #05080d;
    --md-surface: rgba(10, 18, 30, 0.85);
    --md-surface-high: rgba(15, 25, 40, 0.9);
    --md-surface-bright: rgba(25, 40, 60, 0.65);
    --md-outline: rgba(100, 150, 220, 0.12);
    --md-outline-bright: rgba(100, 150, 220, 0.25);

    /* Blue primary palette */
    --md-primary: #60a5fa;
    --md-primary-light: #93c5fd;
    --md-primary-dim: #3b82f6;
    --md-primary-container: rgba(96, 165, 250, 0.12);
    --md-primary-container-hi: rgba(96, 165, 250, 0.22);
    --md-on-primary: #001830;
    --md-primary-glow: rgba(96, 165, 250, 0.35);

    /* Status colors */
    --md-success: #4ade80;
    --md-success-glow: rgba(74, 222, 128, 0.4);
    --md-error: #f87171;
    --md-error-container: rgba(248, 113, 113, 0.15);
    --md-warn: #fbbf24;
    --md-warn-container: rgba(251, 191, 36, 0.15);

    /* Surface text */
    --md-on-surface: #f0f6ff;
    --md-on-surface-med: rgba(240, 246, 255, 0.75);
    --md-on-surface-dim: rgba(240, 246, 255, 0.4);

    /* Glassmorphism */
    --glass-blur: 24px;
    --glass-saturate: 1.6;
    --glass-tint: rgba(30, 60, 110, 0.15);

    /* Elevations with blue tint */
    --elevation-1: 0 1px 3px rgba(0,0,0,0.4), 0 1px 2px rgba(0,10,30,0.3);
    --elevation-2: 0 3px 8px rgba(0,0,0,0.45), 0 1px 3px rgba(0,20,50,0.3);
    --elevation-3: 0 6px 16px rgba(0,0,0,0.5), 0 2px 6px rgba(0,30,70,0.3);

    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --radius-sm: 10px;
    --radius-md: 16px;
    --radius-lg: 24px;
    --radius-full: 9999px;

    /* Transition timing */
    --ease-out: cubic-bezier(0.0, 0.0, 0.2, 1);
    --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
  }

  body {
    background: var(--md-bg);
    color: var(--md-on-surface);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    touch-action: manipulation;
    -webkit-font-smoothing: antialiased;
  }

  #topbar {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    gap: 8px;
    flex-shrink: 0;
    min-height: 56px;
    background: linear-gradient(135deg, var(--md-surface), var(--glass-tint));
    backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturate));
    -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturate));
    border-bottom: 1px solid var(--md-outline);
    box-shadow: 0 1px 0 rgba(255,255,255,0.03);
    z-index: 20;
    position: relative;
  }

  .logo-mark {
    width: 36px; height: 36px;
    border-radius: var(--radius-sm);
    background: linear-gradient(135deg, var(--md-primary-container), var(--md-primary-container-hi));
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; flex-shrink: 0;
    color: var(--md-primary-light);
    box-shadow: inset 0 0 0 1px rgba(96,165,250,0.2), 0 0 20px var(--md-primary-glow);
    transition: all 0.3s var(--ease-out);
  }
  .logo-mark:hover {
    transform: scale(1.05);
    box-shadow: inset 0 0 0 1px rgba(96,165,250,0.3), 0 0 30px var(--md-primary-glow);
  }

  #tabs {
    display: flex; gap: 6px; flex: 1;
    overflow-x: auto; scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
  }
  #tabs::-webkit-scrollbar { display: none; }

  .tab {
    padding: 8px 18px;
    border-radius: var(--radius-full);
    font-size: 13px; font-weight: 600; letter-spacing: 0.01em;
    border: 1px solid transparent;
    background: var(--md-surface-bright);
    color: var(--md-on-surface-med);
    cursor: pointer;
    transition: all 0.25s var(--ease-out);
    white-space: nowrap;
    -webkit-tap-highlight-color: transparent;
    position: relative; overflow: hidden;
  }
  .tab::before {
    content: '';
    position: absolute; inset: 0; border-radius: inherit; opacity: 0;
    background: radial-gradient(circle at center, var(--md-primary-glow) 0%, transparent 70%);
    transition: opacity 0.3s;
  }
  .tab:hover {
    background: rgba(96, 165, 250, 0.1);
    border-color: rgba(96, 165, 250, 0.2);
    color: var(--md-on-surface);
    transform: translateY(-1px);
  }
  .tab:active::before { opacity: 1; }
  .tab:active { transform: scale(0.97); }
  .tab.active {
    background: linear-gradient(135deg, var(--md-primary-container), var(--md-primary-container-hi));
    color: var(--md-primary-light);
    border-color: rgba(96, 165, 250, 0.25);
    box-shadow: 0 0 20px var(--md-primary-glow), inset 0 0 0 1px rgba(96,165,250,0.15);
  }
  .tab.active:hover {
    box-shadow: 0 0 25px var(--md-primary-glow), inset 0 0 0 1px rgba(96,165,250,0.25);
  }

  .dot {
    display: inline-block; width: 7px; height: 7px;
    border-radius: 50%; margin-right: 6px; vertical-align: middle;
    transition: all 0.3s;
  }
  .dot.on { background: var(--md-success); box-shadow: 0 0 8px var(--md-success-glow); }
  .dot.off { background: var(--md-on-surface-dim); }

  #btn-refresh, #btn-clear {
    width: 38px; height: 38px;
    border-radius: var(--radius-full);
    background: var(--md-surface-bright);
    border: 1px solid transparent;
    color: var(--md-on-surface-med);
    font-size: 16px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: all 0.25s var(--ease-out);
    -webkit-tap-highlight-color: transparent;
  }
  #btn-refresh:hover, #btn-clear:hover {
    background: rgba(96, 165, 250, 0.12);
    border-color: rgba(96, 165, 250, 0.2);
    color: var(--md-primary-light);
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(96, 165, 250, 0.2);
  }
  #btn-refresh:active {
    background: var(--md-primary-container);
    color: var(--md-primary);
    transform: rotate(180deg) scale(0.95);
  }
  #btn-clear:active {
    background: var(--md-primary-container);
    color: var(--md-primary);
    transform: scale(0.95);
  }

  #term-wrap {
    flex: 1; position: relative; overflow: hidden;
    background: var(--md-bg);
    box-shadow: inset 0 1px 0 rgba(96, 165, 250, 0.05);
  }
  #term-wrap .xterm { height: 100%; padding: 6px 8px; }
  #term-wrap::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 30px;
    background: linear-gradient(to bottom, rgba(5, 8, 13, 0.9), transparent);
    z-index: 5; pointer-events: none;
  }
  #term-wrap::after {
    content: '';
    position: absolute; bottom: 0; left: 0; right: 0; height: 20px;
    background: linear-gradient(to top, rgba(5, 8, 13, 0.8), transparent);
    z-index: 5; pointer-events: none;
  }

  #status-badge {
    position: absolute; top: 10px; right: 10px;
    padding: 5px 14px; border-radius: var(--radius-full);
    font-size: 11px; font-weight: 600; letter-spacing: 0.02em;
    z-index: 10; display: none; pointer-events: none;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }
  #status-badge.disc {
    display: flex; align-items: center; gap: 6px;
    background: var(--md-error-container);
    color: var(--md-error);
    border: 1px solid rgba(242,131,107,0.2);
    box-shadow: 0 0 16px rgba(242,131,107,0.15);
  }
  #status-badge.recon {
    display: flex; align-items: center; gap: 6px;
    background: var(--md-warn-container);
    color: var(--md-warn);
    border: 1px solid rgba(240,184,102,0.2);
    animation: pulse-badge 2s ease-in-out infinite;
  }
  @keyframes pulse-badge {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  #placeholder {
    position: absolute; inset: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    color: var(--md-on-surface-dim);
    font-size: 14px; text-align: center; padding: 32px; gap: 12px; line-height: 1.6;
  }
  #placeholder.hidden { display: none; }
  #placeholder .ph-icon {
    width: 48px; height: 48px;
    border-radius: var(--radius-md);
    background: var(--md-primary-container);
    display: flex; align-items: center; justify-content: center;
    font-size: 22px; margin-bottom: 4px;
  }

  #ctrlbar {
    display: flex; padding: 8px 10px; gap: 6px; flex-shrink: 0;
    overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none;
    background: linear-gradient(180deg, var(--md-surface), var(--glass-tint));
    backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturate));
    -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturate));
    border-top: 1px solid var(--md-outline);
    box-shadow: 0 -1px 0 rgba(255,255,255,0.02);
    z-index: 20;
  }
  #ctrlbar::-webkit-scrollbar { display: none; }

  .ck {
    padding: 8px 14px; border-radius: var(--radius-sm);
    border: 1px solid var(--md-outline);
    background: rgba(20, 35, 55, 0.6);
    color: var(--md-on-surface-med);
    font-size: 12px; font-weight: 500;
    font-family: 'JetBrains Mono', 'SF Mono', monospace;
    cursor: pointer; white-space: nowrap; flex-shrink: 0;
    min-height: 38px; min-width: 38px;
    display: flex; align-items: center; justify-content: center;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    transition: all 0.2s var(--ease-out);
    position: relative; overflow: hidden;
  }
  .ck::after {
    content: ''; position: absolute; inset: 0; border-radius: inherit;
    background: linear-gradient(135deg, var(--md-primary), var(--md-primary-light));
    opacity: 0; transition: opacity 0.15s;
  }
  .ck:hover {
    background: rgba(96, 165, 250, 0.1);
    border-color: rgba(96, 165, 250, 0.25);
    color: var(--md-on-surface);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3), 0 0 10px rgba(96, 165, 250, 0.15);
  }
  .ck:active::after { opacity: 0.2; }
  .ck:active { transform: scale(0.95) translateY(0); box-shadow: var(--elevation-1); }
  .ck.hi {
    color: var(--md-primary-light);
    border-color: rgba(96,165,250,0.25);
    background: var(--md-primary-container);
  }
  .ck.hi:hover {
    background: var(--md-primary-container-hi);
    box-shadow: 0 0 15px var(--md-primary-glow);
  }
  .ck.hi:active {
    background: var(--md-primary-container-hi);
    box-shadow: 0 0 20px var(--md-primary-glow);
  }
  .ck.sep {
    border: none; background: transparent;
    width: 1px; min-width: 1px; padding: 0; margin: 4px 2px;
    cursor: default; background: var(--md-outline);
  }
  .ck.sep:hover { transform: none; box-shadow: none; }
  .ck.sep::after { display: none; }

  #inputbar {
    display: flex; padding: 12px 14px;
    padding-bottom: calc(12px + var(--safe-bottom));
    gap: 12px; flex-shrink: 0; align-items: flex-end;
    background: linear-gradient(180deg, var(--md-surface-high), rgba(10, 20, 35, 0.95));
    backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturate));
    -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturate));
    border-top: 1px solid var(--md-outline);
    box-shadow: 0 -2px 20px rgba(0,0,0,0.3);
    z-index: 20;
  }

  #txt {
    flex: 1;
    background: rgba(15, 25, 45, 0.8);
    border: 1.5px solid var(--md-outline-bright);
    border-radius: var(--radius-lg);
    padding: 14px 20px;
    color: var(--md-on-surface);
    font-size: 16px; font-family: 'Inter', sans-serif;
    outline: none; resize: none; max-height: 120px; line-height: 1.4;
    transition: all 0.25s var(--ease-out);
  }
  #txt::placeholder { color: var(--md-on-surface-dim); }
  #txt:hover {
    border-color: rgba(96, 165, 250, 0.3);
    background: rgba(20, 35, 55, 0.8);
  }
  #txt:focus {
    border-color: var(--md-primary);
    background: rgba(20, 35, 55, 0.9);
    box-shadow: 0 0 0 3px var(--md-primary-glow), 0 0 30px rgba(96, 165, 250, 0.15);
  }

  #btn-send {
    width: 50px; height: 50px;
    border-radius: var(--radius-full);
    border: none;
    background: linear-gradient(135deg, var(--md-primary), var(--md-primary-dim));
    color: var(--md-on-primary);
    font-size: 20px;
    cursor: pointer; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    -webkit-tap-highlight-color: transparent;
    box-shadow: var(--elevation-2), 0 0 20px var(--md-primary-glow);
    transition: all 0.25s var(--ease-out);
    position: relative; overflow: hidden;
  }
  #btn-send:hover {
    transform: scale(1.08);
    box-shadow: var(--elevation-3), 0 0 30px var(--md-primary-glow);
    background: linear-gradient(135deg, var(--md-primary-light), var(--md-primary));
  }
  #btn-send:active {
    transform: scale(0.95);
    box-shadow: var(--elevation-1), 0 0 15px var(--md-primary-glow);
    background: var(--md-primary-dim);
  }
  #btn-send .ripple {
    position: absolute; border-radius: 50%;
    background: rgba(255,255,255,0.4);
    transform: scale(0);
    animation: ripple-out 0.5s ease-out;
    pointer-events: none;
  }
  @keyframes ripple-out {
    to { transform: scale(2.5); opacity: 0; }
  }

  #login {
    position: fixed; inset: 0;
    background: linear-gradient(180deg, var(--md-bg), rgba(5, 15, 30, 1));
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    z-index: 100; padding: 24px;
  }
  #login.hidden { display: none; }

  .login-card {
    width: 100%; max-width: 400px;
    background: linear-gradient(135deg, var(--md-surface-high), var(--glass-tint));
    backdrop-filter: blur(30px) saturate(1.5);
    -webkit-backdrop-filter: blur(30px) saturate(1.5);
    border-radius: var(--radius-lg);
    border: 1px solid var(--md-outline);
    padding: 36px 32px;
    box-shadow: var(--elevation-3), 0 0 60px rgba(96, 165, 250, 0.08);
    display: flex; flex-direction: column;
    align-items: center; gap: 10px;
  }
  .login-logo {
    width: 64px; height: 64px; border-radius: 18px;
    background: linear-gradient(135deg, var(--md-primary-container), var(--md-primary-container-hi));
    display: flex; align-items: center; justify-content: center;
    font-size: 30px; margin-bottom: 6px;
    color: var(--md-primary-light);
    box-shadow: 0 0 30px var(--md-primary-glow), inset 0 0 0 1px rgba(96,165,250,0.2);
    transition: all 0.3s var(--ease-out);
  }
  .login-logo:hover {
    transform: scale(1.05) rotate(5deg);
    box-shadow: 0 0 40px var(--md-primary-glow), inset 0 0 0 1px rgba(96,165,250,0.3);
  }
  .login-card h1 {
    font-size: 24px; font-weight: 700;
    color: var(--md-on-surface); letter-spacing: -0.02em;
  }
  .login-card p {
    color: var(--md-on-surface-dim); font-size: 14px; margin-bottom: 18px;
  }
  .login-card input {
    width: 100%; padding: 16px 20px;
    border-radius: var(--radius-md);
    border: 1.5px solid var(--md-outline-bright);
    background: rgba(10, 20, 40, 0.6);
    color: var(--md-on-surface); font-size: 16px;
    font-family: 'Inter', sans-serif;
    outline: none;
    transition: all 0.25s var(--ease-out);
  }
  .login-card input:hover {
    border-color: rgba(96, 165, 250, 0.3);
    background: rgba(15, 30, 50, 0.7);
  }
  .login-card input:focus {
    border-color: var(--md-primary);
    background: rgba(15, 30, 50, 0.8);
    box-shadow: 0 0 0 3px var(--md-primary-glow);
  }
  .login-card input::placeholder { color: var(--md-on-surface-dim); }
  .login-btn {
    width: 100%; padding: 16px;
    border-radius: var(--radius-md); border: none;
    background: linear-gradient(135deg, var(--md-primary), var(--md-primary-dim));
    color: var(--md-on-primary);
    font-size: 15px; font-weight: 600;
    font-family: 'Inter', sans-serif; letter-spacing: 0.02em;
    cursor: pointer; margin-top: 10px;
    box-shadow: var(--elevation-2), 0 0 20px var(--md-primary-glow);
    transition: all 0.25s var(--ease-out);
  }
  .login-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--elevation-3), 0 0 30px var(--md-primary-glow);
    background: linear-gradient(135deg, var(--md-primary-light), var(--md-primary));
  }
  .login-btn:active {
    transform: scale(0.98);
    box-shadow: var(--elevation-1);
    background: var(--md-primary-dim);
  }

  /* Ambient blue glow background */
  body::before {
    content: ''; position: fixed;
    top: -50%; left: -30%; width: 160%; height: 80%;
    background: radial-gradient(ellipse at 50% 0%, rgba(96, 165, 250, 0.06) 0%, transparent 55%);
    pointer-events: none; z-index: 0;
  }
  body::after {
    content: ''; position: fixed;
    bottom: -30%; right: -20%; width: 80%; height: 60%;
    background: radial-gradient(ellipse at 80% 100%, rgba(59, 130, 246, 0.04) 0%, transparent 50%);
    pointer-events: none; z-index: 0;
  }
  #topbar, #ctrlbar, #inputbar { position: relative; }
  .tab, .ck, #btn-refresh, #btn-clear, #btn-send, .login-btn { will-change: transform; }
  .xterm-viewport::-webkit-scrollbar { width: 4px; }
  .xterm-viewport::-webkit-scrollbar-track { background: transparent; }
  .xterm-viewport::-webkit-scrollbar-thumb {
    background: var(--md-on-surface-dim); border-radius: 2px;
  }
</style>
</head>
<body>

<div id="login">
  <div class="login-card">
    <div class="login-logo">&#x2B21;</div>
    <h1>Afferent</h1>
    <p>Connect to your screen sessions</p>
    <input type="password" id="tok-in" placeholder="Auth token" autocomplete="off">
    <button class="login-btn" onclick="doLogin()">Connect</button>
  </div>
</div>

<div id="topbar">
  <div class="logo-mark">&#x2B21;</div>
  <div id="tabs"></div>
  <button id="btn-clear" onclick="clearTerm()" title="Clear/Redraw">&#x239A;</button>
  <button id="btn-refresh" onclick="refreshSessions()" title="Refresh Sessions">&#x21BB;</button>
</div>

<div id="term-wrap">
  <div id="status-badge"></div>
  <div id="placeholder">
    <div class="ph-icon">&#x2B21;</div>
    Discovering screen sessions...
  </div>
</div>

<div id="ctrlbar">
  <button class="ck" data-k="ctrl+c">^C</button>
  <button class="ck" data-k="ctrl+d">^D</button>
  <button class="ck" data-k="ctrl+z">^Z</button>
  <button class="ck" data-k="ctrl+l">^L</button>
  <button class="ck" data-k="tab">Tab</button>
  <button class="ck" data-k="escape">Esc</button>
  <div class="ck sep"></div>
  <button class="ck" data-k="up">&#x2191;</button>
  <button class="ck" data-k="down">&#x2193;</button>
  <button class="ck" data-k="left">&#x2190;</button>
  <button class="ck" data-k="right">&#x2192;</button>
  <div class="ck sep"></div>
  <button class="ck hi" data-k="ctrl+a">^A</button>
  <button class="ck hi" data-k="screen-next">^An</button>
  <button class="ck hi" data-k="screen-prev">^Ap</button>
  <button class="ck hi" data-k="screen-list">^A"</button>
  <button class="ck hi" data-k="screen-copy">^A[</button>
</div>

<div id="inputbar">
  <textarea id="txt" rows="1" placeholder="Type a command..." enterkeyhint="send"></textarea>
  <button id="btn-send" onclick="send()"><span style="font-size:18px">&#x25B6;</span></button>
</div>

<script>
let token = localStorage.getItem('csk') || '';
let ws = null, term = null;
let curSession = null, sessions = [];
let reconTimer = null, reconN = 0;

const qp = new URLSearchParams(location.search);
if (qp.get('token')) {
  token = qp.get('token');
  localStorage.setItem('csk', token);
  history.replaceState({}, '', location.pathname);
}
if (token) { hide('login'); init(); }

function doLogin() {
  token = document.getElementById('tok-in').value.trim();
  if (!token) return;
  localStorage.setItem('csk', token);
  hide('login');
  init();
}

function init() {
  initTerm();
  connectWs();
  refreshSessions();
}

function initTerm() {
  if (term) return;
  term = new Terminal({
    theme: {
      background: '#05080d', foreground: '#f0f6ff',
      cursor: '#60a5fa', cursorAccent: '#05080d',
      selectionBackground: 'rgba(96, 165, 250, 0.25)',
      black: '#0a1020', red: '#f87171',
      green: '#4ade80', yellow: '#fbbf24',
      blue: '#60a5fa', magenta: '#c084fc',
      cyan: '#22d3ee', white: '#f0f6ff',
      brightBlack: '#3b4a60', brightRed: '#fca5a5',
      brightGreen: '#86efac', brightYellow: '#fde047',
      brightBlue: '#93c5fd', brightMagenta: '#d8b4fe',
      brightCyan: '#67e8f9', brightWhite: '#ffffff'
    },
    fontSize: 13,
    fontFamily: "'JetBrains Mono','SF Mono','Fira Code','Cascadia Code',Menlo,monospace",
    fontWeight: '400',
    cursorBlink: true,
    cursorStyle: 'bar',
    scrollback: 5000,
    convertEol: true
  });
  term.open(document.getElementById('term-wrap'));
  if (term.textarea) term.textarea.setAttribute('readonly', 'readonly');
  new ResizeObserver(() => fitTerm()).observe(document.getElementById('term-wrap'));
  fitTerm();
}

function fitTerm() {
  if (!term) return;
  const el = document.getElementById('term-wrap');
  const cols = Math.max(20, Math.floor((el.clientWidth - 16) / 7.8));
  const rows = Math.max(5, Math.floor((el.clientHeight - 16) / 17));
  term.resize(cols, rows);
  // Force full redraw to clear rendering artifacts
  requestAnimationFrame(() => term.refresh(0, term.rows - 1));
  wsSend({ type: 'resize', cols, rows });
}

function clearTerm() {
  if (!term) return;
  // Full terminal reset (clears all state, scrollback, etc)
  term.reset();
  // Tell server to clear its buffer too
  wsSend({ type: 'clear_buffer' });
  // Send Ctrl+L to Claude Code to redraw fresh
  setTimeout(() => wsSend({ type: 'control', key: 'ctrl+l' }), 100);
}

function connectWs() {
  if (ws && (ws.readyState === 0 || ws.readyState === 1)) return;
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  const wsUrl = `${proto}://${location.host}?token=${encodeURIComponent(token)}`;
  console.log('Connecting WebSocket to:', wsUrl);
  ws = new WebSocket(wsUrl);
  ws.onopen = () => {
    console.log('WebSocket connected!');
    reconN = 0; setBadge('');
    if (curSession) wsSend({ type: 'attach', session: curSession });
  };
  ws.onmessage = (e) => {
    console.log('WebSocket message:', e.data.substring(0, 100));
    const m = JSON.parse(e.data);
    if (m.type === 'output') term?.write(m.data);
    else if (m.type === 'buffer') { term?.clear(); term?.write(m.data); }
    else if (m.type === 'attached') {
      curSession = m.session; hide('placeholder');
      renderTabs(); fitTerm();
    }
    else if (m.type === 'sessions') { sessions = m.sessions; renderTabs(); }
    else if (m.type === 'session_ended') {
      if (m.session === curSession) {
        curSession = null;
        showPlaceholder('Session ended. Hit refresh to reload.');
      }
      refreshSessions();
    }
    else if (m.type === 'error' && m.message === 'Unauthorized') {
      localStorage.removeItem('csk'); show('login');
    }
  };
  ws.onclose = () => { setBadge('disc'); scheduleRecon(); };
  ws.onerror = () => { setBadge('disc'); };
}

function wsSend(obj) { if (ws?.readyState === 1) ws.send(JSON.stringify(obj)); }

function scheduleRecon() {
  if (reconN >= 12) return;
  reconN++; setBadge('recon');
  clearTimeout(reconTimer);
  reconTimer = setTimeout(connectWs, Math.min(1000 * 1.5 ** reconN, 15000));
}

function setBadge(cls) {
  const b = document.getElementById('status-badge');
  b.className = cls;
  if (cls === 'disc') b.innerHTML = '<span style="font-size:8px">&#x2715;</span> Disconnected';
  else if (cls === 'recon') b.innerHTML = '<span style="font-size:8px">&#x21BB;</span> Reconnecting...';
  else b.innerHTML = '';
}

async function refreshSessions() {
  try {
    const r = await fetch('/api/sessions', { headers: { Authorization: `Bearer ${token}` } });
    const d = await r.json();
    sessions = d.sessions || [];
    renderTabs();
    if (!curSession && sessions.length > 0) switchTo(sessions[0].name);
    else if (sessions.length === 0) showPlaceholder('No screen sessions found.\nStart your sessions, then hit refresh');
  } catch {}
}

function renderTabs() {
  const c = document.getElementById('tabs');
  c.innerHTML = '';
  // Sort sessions alphabetically/numerically
  const sorted = [...sessions].sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));
  sorted.forEach(s => {
    const b = document.createElement('button');
    b.className = 'tab' + (s.name === curSession ? ' active' : '');
    const label = s.name.length > 20 ? s.name.slice(0, 18) + '...' : s.name;
    b.innerHTML = `<span class="dot ${s.connected ? 'on' : 'off'}"></span>${label}`;
    b.onclick = () => switchTo(s.name);
    c.appendChild(b);
  });
}

function switchTo(name) {
  if (name === curSession) return;
  term?.clear();
  wsSend({ type: 'attach', session: name });
}

const txt = document.getElementById('txt');
function send() {
  const v = txt.value.trim();
  if (!v || !curSession) return;
  // Send text first, then Enter separately (mimics real typing)
  wsSend({ type: 'input', data: v });
  setTimeout(() => wsSend({ type: 'input', data: '\r' }), 50);
  txt.value = ''; autoH(); txt.focus();
}
txt.addEventListener('keydown', (e) => {
  console.log('keydown:', e.key);
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
});
txt.addEventListener('input', autoH);
function autoH() {
  txt.style.height = 'auto';
  txt.style.height = Math.min(txt.scrollHeight, 120) + 'px';
}

document.getElementById('ctrlbar').addEventListener('click', (e) => {
  const btn = e.target.closest('[data-k]');
  if (!btn) return;
  wsSend({ type: 'control', key: btn.dataset.k });
  btn.style.transform = 'scale(0.92)';
  btn.style.boxShadow = 'var(--elevation-1)';
  setTimeout(() => { btn.style.transform = ''; btn.style.boxShadow = ''; }, 150);
});

document.getElementById('term-wrap').addEventListener('touchend', (e) => {
  if (!window.getSelection()?.toString()) { e.preventDefault(); txt.focus(); }
});

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') {
    if (!ws || ws.readyState !== 1) connectWs();
    refreshSessions();
  }
});

document.getElementById('btn-send').addEventListener('pointerdown', function(e) {
  const r = document.createElement('span');
  r.className = 'ripple';
  const rect = this.getBoundingClientRect();
  const sz = Math.max(rect.width, rect.height) * 2;
  r.style.width = r.style.height = sz + 'px';
  r.style.left = (e.clientX - rect.left - sz/2) + 'px';
  r.style.top = (e.clientY - rect.top - sz/2) + 'px';
  this.appendChild(r);
  setTimeout(() => r.remove(), 500);
});

function hide(id) { document.getElementById(id).classList.add('hidden'); }
function show(id) { document.getElementById(id).classList.remove('hidden'); }
function showPlaceholder(msg) {
  const p = document.getElementById('placeholder');
  p.innerHTML = `<div class="ph-icon">&#x2B21;</div>${msg.replace('\n', '<br>')}`;
  p.classList.remove('hidden');
}
</script>
</body>
</html>
